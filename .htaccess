# --- Sicherheits- und Performance-Header ---
<IfModule mod_headers.c>
    # Erzwingt die neueste Rendering-Engine von Internet Explorer
    Header set X-UA-Compatible "IE=Edge"
    # Clickjacking-Schutz: Verhindert das Einbetten der Seite in iframes auf fremden Seiten.
    Header set X-Frame-Options "SAMEORIGIN"
    # MIME-Type-Sniffing-Schutz: Verhindert, dass der Browser den Inhaltstyp errät.
    Header set X-Content-Type-Options "nosniff"
    # Referrer-Policy: Kontrolliert, welche Referrer-Informationen gesendet werden.
    Header set Referrer-Policy "no-referrer-when-downgrade"
</IfModule>

# --- Eigene Fehlerseiten (Benutzerfreundlichkeit) ---
# Du musst die Dateien 403.php und 404.php im Hauptverzeichnis erstellen.
ErrorDocument 403 /403.php
ErrorDocument 404 /404.php

# --- Grundlegende Servereinstellungen ---
# Verhindert, dass Besucher die Dateiliste eines Verzeichnisses sehen können.
Options -Indexes
# Schützt diese .htaccess-Datei vor direktem Zugriff über den Browser.
<Files .htaccess>
    Require all denied
</Files>

# --- Umschreibungs- und Weiterleitungsregeln ---
RewriteEngine On

# --- Block 1: Kanonische URL erzwingen (HTTPS & non-www) ---
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# --- Block 2: Schutz vor Hotlinking von Bildern ---
# BITTE "deinedomain.de" durch deine echte Domain ersetzen!
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?twokinds.4lima.de [NC]
RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [NC,F,L]

# --- Block 3: Permanente Weiterleitungen (Redirects) für alte Comic-Pfade ---
# Leitet Anfragen für alte Comic-Seiten-Pfade (z.B. /20250810 oder /20250810.php)
# permanent auf die neue, saubere URL-Struktur um (z.B. /comic/20250810).
# Bedingung: Die Anfrage darf nicht bereits im /comic/ Verzeichnis sein (verhindert Loops).
RewriteCond %{REQUEST_URI} !^/comic/
RewriteCond %{DOCUMENT_ROOT}/comic/$1.php -f
RewriteRule ^(\d{8})(\.php)?$ /comic/$1 [R=301,L]


# --- Block 4: Interne Umschreibungen für "saubere" URLs ---
# Ermöglicht den Aufruf von PHP-Dateien ohne die .php-Endung.
# Gilt für ALLE Pfade, z.B. /kontakt -> /kontakt.php und /comic/20250810 -> /comic/20250810.php
# Bedingung: Die Anfrage ist kein existierendes Verzeichnis.
RewriteCond %{REQUEST_FILENAME} !-d
# Bedingung: Die Anfrage ist keine existierende Datei.
RewriteCond %{REQUEST_FILENAME} !-f
# Bedingung: Eine .php-Datei mit dem angefragten Namen muss existieren.
RewriteCond %{REQUEST_FILENAME}\.php -f
# Regel: Schreibe die Anfrage intern auf die entsprechende .php-Datei um.
RewriteRule ^(.*)$ $1.php [L]


# --- Block 5: GZIP-Komprimierung für schnellere Ladezeiten ---
<IfModule mod_deflate.c>
    # Komprimiere HTML, CSS, JavaScript, Text, XML und Schriften
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
</IfModule>


# --- Block 6: Browser-Caching für statische Inhalte ---
<IfModule mod_expires.c>
    ExpiresActive On
    # Standard-Ablaufzeit
    ExpiresDefault                              "access plus 1 month"
    # CSS
    ExpiresByType text/css                        "access plus 1 year"
    # Bilder
    ExpiresByType image/gif                       "access plus 1 year"
    ExpiresByType image/png                       "access plus 1 year"
    ExpiresByType image/jpg                       "access plus 1 year"
    ExpiresByType image/jpeg                      "access plus 1 year"
    ExpiresByType image/webp                      "access plus 1 year"
    ExpiresByType image/svg+xml                   "access plus 1 year"
    ExpiresByType image/x-icon                    "access plus 1 year"
    # JavaScript
    ExpiresByType application/javascript          "access plus 1 year"
    # Schriftarten
    ExpiresByType application/x-font-ttf          "access plus 1 year"
    ExpiresByType font/opentype                   "access plus 1 year"
</IfModule>

