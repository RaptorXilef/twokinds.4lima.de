# -----------------------------------------------------------------------------
# [DE] GitHub Actions Konfiguration: Automatische Qualit√§tspr√ºfung
# [EN] GitHub Actions Configuration: Automatic Quality Assurance
# -----------------------------------------------------------------------------
# [DE] Dieser Ablauf pr√ºft bei jedem Code-Upload, ob alles stabil und sauber ist.
# [EN] This workflow checks on every code upload if everything is stable and clean.
# -----------------------------------------------------------------------------

name: Project CI

on:
  push:      # [DE] Startet bei jedem Hochladen / [EN] Starts on every push
  pull_request: # [DE] Startet bei Verbesserungsvorschl√§gen / [EN] Starts on pull requests

jobs:
  # =============================================================================
  # [DE] SCHRITT: DIE WERKZEUGKISTE VORBEREITEN
  # [EN] JOB: PREPARE THE TOOLBOX (DEPENDENCIES)
  # =============================================================================
  setup-php-deps:
    name: üì¶ Setup PHP Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Code auschecken / Checkout code
        uses: actions/checkout@v4

      - name: PHP einrichten / Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none # [DE] Spart Zeit (keine Statistik) / [EN] Saves time (no coverage)

      - name: Cache nutzen / Use Cache
        # [DE] Merkt sich installierte Pakete f√ºr das n√§chste Mal (spart viel Zeit)
        # [EN] Remembers installed packages for next time (saves a lot of time)
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-php-

      - name: Pakete installieren / Install packages
        run: composer install --no-progress --prefer-dist

      - name: Werkzeuge f√ºr andere Jobs speichern / Save tools for other jobs
        # [DE] Wir packen die "Werkzeugkiste" ein, damit andere Jobs sie nutzen k√∂nnen
        # [EN] We pack the "toolbox" so other jobs can use it
        uses: actions/upload-artifact@v4
        with:
          name: php-vendor
          path: vendor/
          retention-days: 1

  # =============================================================================
  # [DE] JOB: SCH√ñNHEITSKONTROLLE DES CODES (PRODUKTION - MUSS PERFEKT SEIN)
  # [EN] JOB: CODE STYLE CHECK - SRC (PRODUCTION - MUST BE PERFECT)
  # =============================================================================
  php-phpcs-matrix-src:
    name: üìë PHPCS ${{ matrix.standard }} (src)
    needs: setup-php-deps
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # [DE] Erlaubt das Schreiben von PR-Boxen / [EN] Allows writing PR boxes
      contents: read       # [DE] Erlaubt das Lesen des Codes / [EN] Allows reading code
    strategy:
      fail-fast: false # [DE] Nicht abbrechen, wenn einer scheitert / [EN] Don't stop if one fails
      matrix:
        # [DE] Wir testen verschiedene Regelwerke gleichzeitig
        # [EN] We test different rule sets simultaneously
        standard: [psr12, modern, array, universal, slevomat-coding-standard, security-base]
        folder: [src]
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none }
      - name: Werkzeuge laden / Download tools
        uses: actions/download-artifact@v4
        with: { name: php-vendor, path: vendor/ }

      - name: Berechtigungen & Pfade / Permissions & Paths
        # [DE] Wir machen die Programme startklar und bauen "Lagerhallen" (Ordner) f√ºr Berichte
        # [EN] We make programs ready and build "warehouses" (folders) for reports
        run: |
          chmod -R +x vendor/bin
          mkdir -p .build/reports .cache/phpcs

      - name: Pr√ºfung & Tabelle / Check & Table
        # [DE] Erzeugt die Tabelle f√ºr Menschen UND eine Spezial-Datei f√ºr GitHub
        # [EN] Generates the table for humans AND a special file for GitHub
        run: composer ci:lint-${{ matrix.standard }}-${{ matrix.folder }} -- --report-full --report-checkstyle=.build/reports/phpcs-src-report.xml

      - name: Rote Boxen im Code markieren / Create PR annotations
        if: always()
        uses: staabm/annotate-pull-request-from-checkstyle-action@v1
        with:
          files: .build/reports/phpcs-src-report.xml
          graceful-warnings: true
          colorize: true

  # =============================================================================
  # [DE] JOB: SCH√ñNHEITSKONTROLLE DES CODES (TESTS - DARF "GELB" SEIN)
  # [EN] JOB: CODE STYLE CHECK - TESTS (MAY BE "YELLOW")
  # =============================================================================
  php-phpcs-matrix-tests:
    name: üìù PHPCS ${{ matrix.standard }} (tests)
    needs: setup-php-deps
    runs-on: ubuntu-latest
    continue-on-error: true # [DE] Fehler hier blockieren den Prozess nicht / [EN] Errors here don't block the process
    permissions: { pull-requests: write, contents: read }
    strategy:
      fail-fast: false
      matrix:
        standard: [psr12, modern, array, universal, slevomat-coding-standard, security-base]
        folder: [tests]
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none }
      - uses: actions/download-artifact@v4
        with: { name: php-vendor, path: vendor/ }
      - run: |
          chmod -R +x vendor/bin
          mkdir -p .build/reports .cache/phpcs
      - name: Pr√ºfung & Tabelle (tests)
        run: composer ci:lint-${{ matrix.standard }}-${{ matrix.folder }} -- --report-full --report-checkstyle=.build/reports/phpcs-tests-report.xml
      - name: Annotationen schreiben
        if: always()
        uses: staabm/annotate-pull-request-from-checkstyle-action@v1
        with: { files: .build/reports/phpcs-tests-report.xml }

  # =============================================================================
  # [DE] JOB: LOGIK-PR√úFUNG & SICHERHEIT
  # [EN] JOB: LOGIC CHECK & SECURITY
  # =============================================================================
  phpstan:
    name: üîç PHPStan Analyse
    needs: setup-php-deps
    runs-on: ubuntu-latest
    permissions: { pull-requests: write, contents: read }
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: cs2pr # [DE] Spezial-√úbersetzer f√ºr GitHub / [EN] Special translator for GitHub
      - uses: actions/download-artifact@v4
        with: { name: php-vendor, path: vendor/ }
      - run: |
          chmod -R +x vendor/bin
          mkdir -p .build/reports .cache/phpstan

      - name: PHPStan Analyse & PR-Boxen
        # [DE] Wir machen zwei Durchl√§ufe: Einer f√ºr GitHub, einer f√ºr deine Augen (Tabelle)
        # [EN] We do two runs: One for GitHub, one for your eyes (table)
        run: |
          ./vendor/bin/phpstan analyse --error-format=checkstyle --no-progress > .build/reports/phpstan-report.xml || true
          ./vendor/bin/phpstan analyse --no-progress || true
          cs2pr .build/reports/phpstan-report.xml

      - name: Sicherheits-Audit / Security Audit
        # [DE] Pr√ºft, ob deine Pakete bekannte Sicherheitsl√ºcken haben
        # [EN] Checks if your packages have known security vulnerabilities
        if: always()
        run: composer audit

# =============================================================================
  # [DE] JOB: COPY-PASTE DETEKTOR (CODE-DUPLIKATE)
  # [EN] JOB: COPY-PASTE DETECTOR (CODE DUPLICATION)
  # =============================================================================
  phpcpd-check:
    name: üëØ PHPCPD Check
    needs: setup-php-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none }
      - uses: actions/download-artifact@v4
        with: { name: php-vendor, path: vendor/ }

      - name: Vorbereitung / Preparation
        run: chmod -R +x vendor/bin

      - name: Suche nach Code-Duplikaten / Scan for code duplication
        # [DE] Sucht nach min. 5 identischen Zeilen oder 70 Tokens
        # [EN] Scans for min. 5 identical lines or 70 tokens
        run: ./vendor/bin/phpcpd src/ --min-lines=5 --min-tokens=70

  # =============================================================================
  # [DE] JOB: MESS DETECTOR (SAUBERER CODE & DESIGN)
  # [EN] JOB: MESS DETECTOR (CLEAN CODE & DESIGN)
  # =============================================================================
  phpmd-check:
    name: üßπ PHPMD Check
    needs: setup-php-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none }
      - uses: actions/download-artifact@v4
        with: { name: php-vendor, path: vendor/ }

      - name: Vorbereitung / Preparation
        run: chmod -R +x vendor/bin

      - name: Analysiere Code-Struktur / Analyze code structure
        # [DE] Pr√ºft src/ Ordner mit Regeln aus phpmd.xml. Ausgabeformat: Text (gut lesbar in Logs)
        # [EN] Checks src/ folder using rules from phpmd.xml. Output format: Text (readable in logs)
        run: ./vendor/bin/phpmd src/ text phpmd.xml

  # =============================================================================
  # [DE] JOB: AUTOMATISCHES REFACTORING PR√úFUNG (RECTOR)
  # [EN] JOB: AUTOMATED REFACTORING CHECK (RECTOR)
  # =============================================================================
  rector-check:
    name: ‚ôªÔ∏è Rector Check
    needs: setup-php-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none }
      - uses: actions/download-artifact@v4
        with: { name: php-vendor, path: vendor/ }
      - run: |
          chmod -R +x vendor/bin
          mkdir -p .build/reports .cache/phpunit

      - name: Rector Tests
        # [DE] --dry-run pr√ºft nur, √§ndert aber nichts. Wenn Rector meckert, schl√§gt der Job fehl.
        # [EN] --dry-run only checks, doesn't change files. If Rector complains, the job fails.
        run: ./vendor/bin/rector process --dry-run

  # =============================================================================
  # [DE] JOB: FUNKTIONSTEST (PHPUNIT)
  # [EN] JOB: FUNCTIONAL TESTS (PHPUNIT)
  # =============================================================================
  phpunit-tests:
    name: üß™ PHPUnit Tests
    needs: setup-php-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none }
      - uses: actions/download-artifact@v4
        with: { name: php-vendor, path: vendor/ }
      - run: |
          chmod -R +x vendor/bin
          mkdir -p .build/reports .cache/phpunit

      - name: PHPUnit Tests
        # [DE] --testdox erzeugt eine wunderbare Checkliste deiner Tests
        # [EN] --testdox generates a wonderful checklist of your tests
        run: ./vendor/bin/phpunit --configuration .phpunit.xml.dist --testdox --testdox-html .build/reports/phpunit-report.html

      - name: Testbericht speichern / Save test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-html-report
          path: .build/reports/phpunit-report.html

  # =============================================================================
  # [DE] JOB: FRONTEND-QUALIT√ÑT (JS, SCSS, HTML)
  # [EN] JOB: FRONTEND QUALITY (JS, SCSS, HTML)
  # =============================================================================
  frontend-quality:
    name: üåê Frontend Quality ${{ matrix.check }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [lint:js, lint:scss, lint-ci:html]
    steps:
      - uses: actions/checkout@v4
      - name: PHP Setup (nur f√ºr HTML Lint)
        if: matrix.check == 'lint-ci:html'
        uses: shivammathur/setup-php@v2
        with: { php-version: '8.3' }

      - name: Node.js einrichten
        uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }

      - run: npm ci

      - name: Frontend Check
        run: |
          if [ "${{ matrix.check }}" == "lint-ci:html" ]; then
            # [DE] Startet kurz einen Webserver f√ºr den Barrierefreiheits-Check
            # [EN] Briefly starts a webserver for the accessibility check
            php -S 127.0.0.1:8000 -t public &
            sleep 3
          fi
          npm run ${{ matrix.check }}

      - name: JS Sicherheits-Audit
        if: matrix.check == 'lint:js'
        run: npm audit
