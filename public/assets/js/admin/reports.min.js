/**
 * @file      ROOT/resources/js/admin_reports.js
 * @package   twokinds.4lima.de
 * @author    Felix M. (@RaptorXilef)
 * @copyright 2025 Felix M.
 * @license   Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
 * @link      https://github.com/RaptorXilef/twokinds.4lima.de
 * @version   1.1.0
 * @since     1.0.0 Initiale Erstellung
 * @since     1.1.0 Anpassung an HTML-Transkripte und neue Modal-Struktur in management_reports.php
 *
 * @description Dieses Skript steuert das Detail-Modal auf der Seite management_reports.php.
 * Es befüllt das Modal mit Daten (HTML gerendert, HTML-Code) und
 * generiert eine visuelle Text-Diff-Ansicht mit jsDiff.
 */
document.addEventListener("DOMContentLoaded",()=>{const debugMode=window.debugMode||false;const modal=document.getElementById("report-detail-modal");const table=document.getElementById("reports-table");if(!modal||!table){if(debugMode)console.log("DEBUG [admin_reports.js]: Modal oder Tabelle nicht gefunden. Skript beendet.");return}const modalContent=document.getElementById("report-detail-content");const comicLink=document.getElementById("detail-comic-link");const comicIdSpan=document.getElementById("detail-comic-id");const dateSpan=document.getElementById("detail-date");const submitterSpan=document.getElementById("detail-submitter");const typeSpan=document.getElementById("detail-type");const descriptionContainer=document.getElementById("detail-description-container");const descriptionP=document.getElementById("detail-description");const transcriptSection=document.getElementById("detail-transcript-section");const diffViewer=document.getElementById("detail-diff-viewer");const suggestionHtmlDisplay=document.getElementById("detail-suggestion-html");const suggestionCodeTextarea=document.getElementById("detail-suggestion-code");const apiBaseUrl=window.adminApiEndpoints?.getComicData||"./api/get_comic_data.php";const csrfToken=window.csrfToken||"";const openModal=row=>{const dataset=row.dataset;const comicId=dataset.comicId||"k.A.";const reportType=dataset.type||"k.A.";const description=dataset.fullDescription||"";const suggestion=dataset.suggestion||"";const original=dataset.original||"";comicIdSpan.textContent=comicId;comicLink.href=`./comic.php?id=${comicId}`;try{const linkInTable=row.querySelector('td a[target="_blank"]');if(linkInTable){comicLink.href=linkInTable.href}}catch(e){}dateSpan.textContent=dataset.date||"k.A.";submitterSpan.textContent=dataset.submitter||"k.A.";typeSpan.textContent=reportType;if(description){descriptionP.textContent=description}else{descriptionP.textContent="Keine Beschreibung vorhanden."}descriptionContainer.style.display="block";if(reportType==="transcript"){transcriptSection.style.display="block";if(suggestion){if(suggestionHtmlDisplay)suggestionHtmlDisplay.innerHTML=suggestion;if(suggestionCodeTextarea)suggestionCodeTextarea.value=suggestion}else{if(suggestionHtmlDisplay)suggestionHtmlDisplay.innerHTML="<em>Kein Vorschlag (HTML).</em>";if(suggestionCodeTextarea)suggestionCodeTextarea.value="Kein Vorschlag (Code)."}diffViewer.innerHTML='<p class="loading-text">Text-Diff wird generiert...</p>';if(debugMode)console.log('DEBUG [admin_reports.js]: Verwende "Original" aus dem Report für Diff.');generateTextDiff(original,suggestion)}else{transcriptSection.style.display="none"}modal.style.display="flex"};const closeModal=()=>{modal.style.display="none";diffViewer.innerHTML="";if(suggestionHtmlDisplay)suggestionHtmlDisplay.innerHTML="";if(suggestionCodeTextarea)suggestionCodeTextarea.value=""};modal.addEventListener("click",e=>{if(e.target.dataset.action==="close-detail-modal"){closeModal()}});table.addEventListener("click",e=>{const detailButton=e.target.closest(".detail-button");if(detailButton){const row=detailButton.closest("tr");if(row){openModal(row)}}});document.addEventListener("keydown",e=>{if(e.key==="Escape"&&modal.style.display==="flex"){closeModal()}});const convertHtmlToText=html=>{if(html&&html.trim().startsWith("<")){const tempDiv=document.createElement("div");tempDiv.innerHTML=html;tempDiv.querySelectorAll("p").forEach(p=>{p.after(document.createTextNode("\n"))});tempDiv.querySelectorAll("br").forEach(br=>{br.after(document.createTextNode("\n"))});return(tempDiv.textContent||tempDiv.innerText||"").trim()}return(html||"").trim()};const generateTextDiff=(originalHtml,suggestionHtml)=>{if(typeof Diff==="undefined"||typeof Diff.diffLines==="undefined"){diffViewer.innerHTML='<p class="status-message status-red">Fehler: jsDiff-Bibliothek nicht geladen.</p>';return}if(!suggestionHtml){diffViewer.innerHTML='<p class="status-message status-info">Kein Transkript-Vorschlag vorhanden.</p>';return}const originalText=convertHtmlToText(originalHtml);const suggestionText=convertHtmlToText(suggestionHtml);if(originalText===suggestionText){diffViewer.innerHTML='<p class="status-message status-info">Keine Änderungen am reinen Textinhalt gefunden.</p>';return}const diff=Diff.diffLines(originalText,suggestionText,{newlineIsToken:true});const fragment=document.createDocumentFragment();diff.forEach(part=>{const node=document.createElement(part.added?"ins":part.removed?"del":"span");if(part.value.match(/^\s+$/)){node.style.opacity="0.6";node.appendChild(document.createTextNode("[Whitespace-Änderung]"))}else{node.appendChild(document.createTextNode(part.value))}fragment.appendChild(node)});diffViewer.innerHTML="";diffViewer.appendChild(fragment)}});
//# sourceMappingURL=reports.min.js.map