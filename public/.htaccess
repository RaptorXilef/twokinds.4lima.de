# ##############################################################################
# ##                                                                          ##
# ##      UMFASSENDE .HTACCESS-KONFIGURATION FÜR PERFORMANCE & SICHERHEIT     ##
# ##                 -- Finale Optimierungsstufe --                           ##
# ##                                                                          ##
# ##############################################################################
# Autor:    Felix Maywald alias RaptorXilef
# Webseite: https://twokinds.4lima.de
# GitHub:   https://github.com/RaptorXilef/twokinds.4lima.de
# Lizenz:   Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
#           <https://creativecommons.org/licenses/by-nc-sa/4.0/>
# Hinweis:  Diese .htaccess-Datei ist speziell für die Webseite twokinds.4lima.de
#           optimiert und kann als Vorlage für eigene Projekte dienen.
#           Bitte passe die Domain-Namen und Pfade entsprechend deiner Webseite an.
# Version:  5.0.0

# --- Block 1: UTF-8 Erzwingung & Verzeichniseinstellungen ---
# Stellt sicher, dass alle Textinhalte korrekt kodiert übertragen werden.
AddDefaultCharset UTF-8
DefaultLanguage de-DE

# --- Block 2: Sicherheits- und Kompatibilitäts-Header ---
# Dieser Block sendet bei jeder Anfrage wichtige HTTP-Header mit,
# die den Browser anweisen, sich sicherer zu verhalten und die Seite korrekt darzustellen.
<IfModule mod_headers.c>
    # Erzwingt, dass der Internet Explorer immer die neueste verfügbare Rendering-Engine verwendet.
    Header set X-UA-Compatible "IE=Edge"

    # Clickjacking-Schutz: Erlaubt das Einbetten der Seite via <iframe>, <embed> oder <object> nur von der eigenen Domain.
    Header set X-Frame-Options "SAMEORIGIN"

    # MIME-Type-Sniffing-Schutz: Verhindert, dass der Browser versucht, den Inhaltstyp einer Datei zu "erraten",
    # was eine Sicherheitslücke sein kann. Der Browser muss dem vom Server deklarierten Content-Type vertrauen.
    Header set X-Content-Type-Options "nosniff"

    # Referrer Policy: Steuert, welche Referrer-Informationen gesendet werden.
    # strict-origin-when-cross-origin: Sendet vollen Referrer bei gleicher Domain, nur Origin bei HTTPS->HTTPS Cross-Origin.
    Header set Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions Policy: Erlaubt oder verbietet Browser-Features.
    # Hier: Deaktiviert Geolocation, Mikrofon und Kamera für mehr Privatsphäre.
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"

</IfModule>

# --- Block 3: Eigene Fehlerseiten (Benutzerfreundlichkeit) ---
# Zeigt anstelle der technischen Standard-Fehlerseiten des Servers eigene,
# benutzerfreundliche und im Design der Webseite gehaltene Seiten an.
# WICHTIG: Du musst die Dateien 403.php und 404.php im Hauptverzeichnis deiner Webseite erstellen.
ErrorDocument 403 /403.php
ErrorDocument 404 /404.php

# --- Block 4: Grundlegende Servereinstellungen & Basisschutz ---
# Verhindert "Directory Listing" und das "Erraten" von Dateinamen (MultiViews).
Options -Indexes -MultiViews
DirectoryIndex index.php index.html

# Schützt diese .htaccess-Datei selbst und andere sensible Konfigurationsdateien vor direktem Zugriff über den Browser.
<FilesMatch "(^\.htaccess|php\.ini|licence\.txt|readme\.html|composer\.json|package\.json)$">
    Require all denied
</FilesMatch>

# --- Block 5: Umschreibungs- und Weiterleitungsregeln ---
# Das Herzstück für saubere, SEO-freundliche URLs.
RewriteEngine On

# Sicherheits-Zusatz: Blockiere bekannte Exploit-Muster in URLs
RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2})
RewriteRule ^(.*)$ - [F,L]

# Stoppt die Umschreibung für die Fehlerdokumente.
# Dies verhindert Endlosschleifen (Loops) bei der Fehlerbehandlung,
# die auf manchen Live-Servern (anders als bei XAMPP) auftreten,
# wenn der interne Sub-Request für die Fehlerseite erneut umgeschrieben wird.
RewriteCond %{REQUEST_URI} ^/(403|404)\.php$
RewriteRule ^ - [L]

# ===========================================================
# SPEZIAL-FIX: Konfliktlösung Charaktere (HIER IST DER TRICK)
# ===========================================================

# 1. Wer die alte .php Datei aufruft -> ab zur neuen Seite
RewriteRule ^charaktere\.php$ /charakter-vorstellung [R=301,L]

# 2. Wer /charaktere (OHNE Slash) aufruft -> ab zur neuen Seite
# Wir nutzen %{THE_REQUEST}, um dem Server zuvorzukommen, bevor er den Ordner-Slash erzwingt.
# Dies fängt "GET /charaktere " ab, ignoriert aber "GET /charaktere/ "
RewriteCond %{THE_REQUEST} \s/charaktere(\s|\?) [NC]
RewriteRule ^ /charakter-vorstellung [R=301,L]

# (Wer /charaktere/ MIT Slash eingibt, wird von dieser Regel ignoriert
# und landet ganz normal im Ordner bei der index.php)
# ===========================================================

# 5a: Kanonische URL erzwingen (HTTPS & non-www)
# Leitet alle Anfragen auf https://meine-domain.de um,
# um doppelten Inhalt (Duplicate Content) bei Suchmaschinen zu vermeiden.
# Erzwingt HTTPS für alle Anfragen.
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Erzwingt die "non-www"-Version (ohne www. davor).
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# 5b: Schutz vor Hotlinking von Bildern
# Verhindert, dass andere Webseiten deine Bilder direkt einbinden und so deinen Traffic verbrauchen.
# Bilder werden nur angezeigt, wenn der Aufruf von deiner eigenen Domain kommt.
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?twokinds\.4lima\.de [NC]
RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?twokinds\.4lima\.local [NC]
RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [NC,F,L]

# -----------------------------------------------------------
# 5c: SPEZIAL-REGEL (Muss VOR der allgemeinen Regel stehen)
# Leitet alte Root-Dateien (mit oder ohne .php) direkt in den Comic-Ordner
# -----------------------------------------------------------
# Permanente Weiterleitungen (Redirects) für alte Comic-Pfade
# Leitet Besucher und Suchmaschinen von der alten URL-Struktur (z.B. /20250810.php)
# permanent (301) auf die neue, saubere URL-Struktur (z.B. /comic/20250810) um.
# Bedingung: Die Anfrage darf nicht bereits im /comic/ Verzeichnis sein (verhindert Loops/Endlosschleifen).
RewriteCond %{REQUEST_URI} !^/comic/
RewriteCond %{DOCUMENT_ROOT}/comic/$1.php -f
RewriteRule ^(\d{8})(\.php)?$ /comic/$1 [R=301,L]

# -----------------------------------------------------------
# 5d: Trailing Slash entfernen
# -----------------------------------------------------------
# Trailing-Slash-Weiterleitung (SEO-Optimierung)
# Entfernt den Schrägstrich (/) am Ende von URLs (z.B. /kontakt/ -> /kontakt) (301).
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /$1 [R=301,L]

# -----------------------------------------------------------
# NEU: INDEX BEREINIGUNG (Muss VOR der allgemeinen .php Regel stehen)
# Entfernt "index.php" UND "index" aus allen Pfaden
# /index.php -> /
# /admin/index.php -> /admin/
# /charaktere/index.php -> /charaktere/
# -----------------------------------------------------------
RewriteCond %{THE_REQUEST} \s/+((.*?)/)?index(\.php)?[\s?] [NC]
RewriteRule ^ /%1 [R=301,L,NE]

# -----------------------------------------------------------
# NEU: ALLGEMEINE BEREINIGUNG (Das haben wir vorhin hinzugefügt)
# Entfernt .php von ALLEN anderen Dateien (auch die im /comic/ Ordner)
# Greift nur, wenn Regel 4c nicht schon zugeschlagen hat.
# -----------------------------------------------------------
# RewriteCond %{REQUEST_URI} !(^/api/|^/admin/api/)
# 1. Bedingung: Nicht im API-Ordner
RewriteCond %{REQUEST_URI} !^/(api|admin/api)/
# 2. Bedingung: Die Anfrage enthält .php
RewriteCond %{THE_REQUEST} \s/+(.+?)\.php[\s?] [NC]
# Regel: 301-Weiterleitung auf die URL ohne .php
RewriteRule ^ /%1 [R=301,L,NE]

# -----------------------------------------------------------
# 5e: INTERNE UMSCHREIBUNG (Damit die Seiten ohne .php funktionieren)
# -----------------------------------------------------------
# Interne Umschreibungen für "saubere" URLs (ohne .php-Endung)
# Dies ist die zentrale Regel, die für ALLE Ordner gilt.
# Sie ermöglicht den Aufruf von PHP-Dateien ohne die .php-Endung.
# Dies geschieht intern auf dem Server; der Besucher sieht die saubere URL.
# z.B. /kontakt -> /kontakt.php
# z.B. /charaktere/name -> /charaktere/name.php
# z.B. /comic/20250810 -> /comic/20250810.php
RewriteCond %{REQUEST_FILENAME} !-d
# Bedingung: Die Anfrage ist keine existierende Datei.
RewriteCond %{REQUEST_FILENAME} !-f
# Bedingung: Eine .php-Datei mit dem angefragten Namen muss existieren.
RewriteCond %{REQUEST_FILENAME}\.php -f
# Regel: Schreibe die Anfrage intern auf die entsprechende .php-Datei um.
RewriteRule ^(.*)$ $1.php [L]

# ### HINWEIS: Der Block "NEUE REGELN" wurde wieder entfernt. ###
# Die Funktionalität war bereits durch die Regeln 4c und 4e abgedeckt.
# Eine einzige, allgemeine Regel (4e) ist sauberer und weniger fehleranfällig.

# --- Block 6: GZIP-Komprimierung (Performance - Kategorisiert) ---
<IfModule mod_deflate.c>
    # 1. Text- und Dokumentformate
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css

    # 2. Skripte (JavaScript)
    AddOutputFilterByType DEFLATE text/javascript application/javascript

    # 3. Datenaustausch-Formate
    AddOutputFilterByType DEFLATE application/json application/xml

    # 4. Web-Fonts und Vektorgrafiken
    AddOutputFilterByType DEFLATE font/woff2 font/ttf image/svg+xml
</IfModule>

# --- Block 7: Expires-Caching & CORS (The Perfect Mix) ---
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"

    # Bilder & Fonts: 1 Jahr
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"

    # Daten & Styles: 1 Monat
    ExpiresByType application/json "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>

# --- Block 8: Browser-Caching (Performance) ---
# Weist den Browser des Besuchers an, statische Dateien (Bilder, CSS, JS) für einen
# langen Zeitraum lokal zu speichern. Bei einem erneuten Besuch müssen diese Dateien nicht
# erneut vom Server geladen werden, was die Seite extrem beschleunigt.
<IfModule mod_headers.c>
  # Caching-Regel für Bilder und Schriftarten
  # Diese Dateien werden sehr selten aktualisiert und können lange gecacht werden.
# Ziel: Alle statischen Assets (Bilder, Schriften, Daten)
 <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|x-icon|ttf|otf|woff2|json)$">

    # 1. Caching: Diese Dateien werden selten geändert (1 Jahr Cache)
    Header set Cache-Control "max-age=31536000, public"

    # 2. CORS: Selektive Freigabe für Schriften, Bilder & JSON
    # Erlaubt .local den Zugriff auf Ressourcen von .de
    SetEnvIf Origin "https?://(twokinds\.4lima\.local|twokinds\.4lima\.de)$" AccessControlAllowOrigin=$0
    Header add Access-Control-Allow-Origin %{AccessControlAllowOrigin}e env=AccessControlAllowOrigin

    # Wichtig: Informiert den Browser-Cache, dass die Antwort vom Ursprung (Origin) abhängt
    Header merge Vary Origin

 </FilesMatch>

  # Caching-Regel für CSS- und JS-Dateien
  # Diese werden nur für einen Monat im Cache gehalten, wie von dir gewünscht.
 <FilesMatch "\.(css|js)$">
    Header set Cache-Control "max-age=2592000, public"
 </FilesMatch>
</IfModule>

# --- Block 9: Korrekte MIME-Typen für moderne Formate ---
# Stellt sicher, dass moderne Dateiformate vom Server mit dem korrekten
# Content-Type-Header ausgeliefert werden, um Darstellungsprobleme im Browser zu vermeiden.
<IfModule mod_mime.c>
    AddType image/webp                      .webp
    AddType image/svg+xml                   .svg .svgz
    AddType font/woff2                      .woff2
    AddType application/json                .json
</IfModule>

# --- Block 10: ETags entfernen (Performance-Optimierung) ---
# ETags sind eine Methode zur Validierung von Cache-Dateien. In manchen Konfigurationen
# können sie das Caching behindern oder unnötige Server-Informationen preisgeben.
# Das Entfernen ist eine gängige Best-Practice-Optimierung.
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# --- Block 11: Erweiterte Sicherheits-Header (CSP & HSTS) ---
# Dies sind fortgeschrittene Header, die einen robusten Schutz gegen moderne Web-Angriffe bieten.
<IfModule mod_headers.c>
    # Content Security Policy (CSP): Definiert eine Whitelist für ausführbare Ressourcen.
    # Dies ist eine sehr effektive Maßnahme gegen Cross-Site-Scripting (XSS).
    # Die Zeilen werden mit einem Backslash (\) zusammengefügt, um die Lesbarkeit zu verbessern.
    # Header set Content-Security-Policy "\
    # default-src 'self'; \
    # script-src 'self' 'unsafe-inline' https://cdn.twokinds.keenspot.com https://twokinds.keenspot.com https://www.2kinds.com https://cdnjs.cloudflare.com https://placehold.co https://www.googletagmanager.com https://cdn.tailwindcss.com https://code.jquery.com https://cdn.jsdelivr.net; \
    # style-src 'self' 'unsafe-inline' https://cdn.twokinds.keenspot.com https://twokinds.keenspot.com https://www.2kinds.com https://cdnjs.cloudflare.com https://fonts.googleapis.com https://cdn.jsdelivr.net; \
    # img-src 'self' data: https://cdn.twokinds.keenspot.com https://twokinds.keenspot.com https://twokindscomic.com https://www.2kinds.com https://placehold.co https://i.creativecommons.org/l/by-nc-sa/3.0/de/88x31.png https://licensebuttons.net https://twokinds.4lima.de; \
    # font-src 'self' https://cdnjs.cloudflare.com https://cdn.twokinds.keenspot.com https://fonts.gstatic.com https://cdn.jsdelivr.net https://twokinds.4lima.de; \
    # connect-src 'self' https://*.google-analytics.com https://cdn.twokinds.keenspot.com https://twokindscomic.com https://cdn.jsdelivr.net;"

    # HTTP Strict Transport Security (HSTS): Weist den Browser an, die Seite nur über HTTPS aufzurufen.
    # WICHTIGER HINWEIS: Aktiviere diese Zeile erst, wenn du sicher bist, dass deine HTTPS-Konfiguration
    # dauerhaft und fehlerfrei funktioniert. Einmal gesetzt, wird der Browser für die angegebene
    # Zeit (max-age) keine HTTP-Verbindungen mehr zulassen.
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set Strict-Transport-Security "max-age=300; includeSubDomains; preload"

    # CSP wird dynamisch in PHP verwaltet (init_admin.php).
</IfModule>
