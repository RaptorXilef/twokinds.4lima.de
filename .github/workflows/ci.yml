# -----------------------------------------------------------------------------
# [DE] GitHub Actions Konfiguration: Automatische Qualit√§tspr√ºfung (CI)
# [EN] GitHub Actions Configuration: Automatic Quality Assurance (CI)
# -----------------------------------------------------------------------------
# Beschreibung: Dieser Workflow pr√ºft bei jedem Push und Pull Request die
# Code-Qualit√§t, Sicherheit und Funktionalit√§t f√ºr PHP und Frontend.
# -----------------------------------------------------------------------------

name: Project CI

on:
  push:
    branches: [ '**' ] # [DE] Pr√ºft jeden Push / [EN] Checks every push
  pull_request:
    branches: [ '**' ] # [DE] Pr√ºft jeden Pull Request / [EN] Checks every PR

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # [DE] SETUP: ABH√ÑNGIGKEITEN VORBEREITEN
  # [EN] SETUP: PREPARE DEPENDENCIES
  # =============================================================================
  setup:
    name: üì¶ Setup & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: PHP Setup
        uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none, tools: composer }

      # [DE] Validiert die composer.json / [EN] Validates composer.json
      - name: Validate Composer
        run: composer validate --strict

      - name: Cache PHP
        # [DE] Merkt sich installierte Pakete f√ºr das n√§chste Mal (spart viel Zeit)
        # [EN] Remembers installed packages for next time (saves a lot of time)
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-php-

      # [DE] Cache (spart massiv Rechenzeit bei Folgel√§ufen)
      # [EN] Cache (saves massive compute time on subsequent runs)
      # [DE] Cache f√ºr PHPCS
      - name: Cache PHPCS
        uses: actions/cache@v4
        with:
          path: .cache/phpcs
          key: ${{ runner.os }}-phpcs-${{ hashFiles('phpcs.xml.dist') }}
          restore-keys: ${{ runner.os }}-phpcs- # KORRIGIERT: phpcs statt phpunit

      # [DE] Cache f√ºr PHPUnit
      - name: Cache PHPUNIT
        uses: actions/cache@v4
        with:
          path: .cache/phpunit
          key: ${{ runner.os }}-phpunit-${{ hashFiles('phpunit.xml.dist') }}
          restore-keys: ${{ runner.os }}-phpunit-

      # [DE] NEU: Cache f√ºr PHPStan (macht die Analyse bei Folgel√§ufen extrem schnell)
      - name: Cache PHPSTAN
        uses: actions/cache@v4
        with:
          path: .cache/phpstan
          key: ${{ runner.os }}-phpstan-${{ hashFiles('phpstan.neon.dist') }}
          restore-keys: ${{ runner.os }}-phpstan-

      - name: Install packages / Pakete installieren
        run: composer install --no-progress --prefer-dist

      - name: Node Setup
        uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }

      # [DE] Validiert die package.json Syntax / [EN] Validates package.json syntax
      - name: Validate NPM Package
        run: |
          node -e "try { JSON.parse(require('fs').readFileSync('./package.json')); console.log('package.json is valid JSON'); } catch (e) { console.error('Invalid package.json'); process.exit(1); }"
          npm pkg get name # Pr√ºft zus√§tzlich, ob npm das Paket korrekt einlesen kann

      - run: npm ci

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-dependencies
          path: |
            vendor/
            node_modules/
            .cache/
          retention-days: 1

  # =============================================================================
  # [DE] PHP CODE STYLE (PRODUKTION)
  # [EN] PHP CODE STYLE (PRODUCTION)
  # =============================================================================
  phpcs-src:
    name: üìë PHPCS ${{ matrix.standard }} (${{ matrix.folder }})
    needs: setup
    runs-on: ubuntu-latest
    permissions: { pull-requests: write, contents: read }
    strategy:
      fail-fast: false
      matrix:
        standard: [psr12, universal, slevomat]
        folder: [src]
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none }
      - uses: actions/download-artifact@v4
        with: { name: all-dependencies }
      - name: Prepare paths
        run: |
          chmod -R +x vendor/bin
          mkdir -p .build/reports .cache/phpcs
      - name: Run Check
        run: composer ci:chk:${{ matrix.standard }}:${{ matrix.folder }} -- --report-full --report-checkstyle=.build/reports/phpcs-${{ matrix.folder }}-report.xml --cache=.cache/phpcs/cache.json
      - name: Annotate PR
        if: always()
        uses: staabm/annotate-pull-request-from-checkstyle-action@v1
        with:
          files: .build/reports/phpcs-${{ matrix.folder }}-report.xml
          graceful-warnings: true
          colorize: true}

  # =============================================================================
  # [DE] PHP CODE STYLE (TESTS)
  # [EN] PHP CODE STYLE (TESTS)
  # =============================================================================
  phpcs-tests:
    name: üìù PHPCS ${{ matrix.standard }} (${{ matrix.folder }})
    needs: setup
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions: { pull-requests: write, contents: read }
    strategy:
      fail-fast: false
      matrix:
        standard: [psr12, universal, slevomat]
        folder: [tests]
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none }
      - uses: actions/download-artifact@v4
        with: { name: all-dependencies }
      - name: Prepare paths
        run: |
          chmod -R +x vendor/bin
          mkdir -p .build/reports .cache/phpcs
      - name: Run Check
        run: composer ci:chk:${{ matrix.standard }}:${{ matrix.folder }} -- --report-full --report-checkstyle=.build/reports/phpcs-${{ matrix.folder }}-report.xml --cache=.cache/phpcs/cache.json
      - name: Annotate PR
        if: always()
        uses: staabm/annotate-pull-request-from-checkstyle-action@v1
        with: { files: .build/reports/phpcs-${{ matrix.folder }}-report.xml, graceful-warnings: true, colorize: true}

  # =============================================================================
  # [DE] LOGIK-ANALYSE (PHPSTAN)
  # [EN] LOGIC ANALYSIS (PHPSTAN)
  # =============================================================================
  phpstan:
    name: üîç PHPStan Analysis
    needs: setup
    runs-on: ubuntu-latest
    permissions: { pull-requests: write, contents: read }
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', tools: cs2pr }
      - uses: actions/download-artifact@v4
        with: { name: all-dependencies }
      - run: mkdir -p .build/reports .cache/phpstan
      - name: PHPStan Run & PR Annotations
        run: |
          composer ci:chk:stan
          cs2pr .build/reports/phpstan-report.xml

  # =============================================================================
  # [DE] WEITERE PHP CHECKS (DUPLICATES, MESS, RECTOR)
  # [EN] FURTHER PHP CHECKS (DUPLICATES, MESS, RECTOR)
  # =============================================================================
  php-extra-checks:
    name: ${{ matrix.icon }} PHP ${{ matrix.name }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Duplicates
            check: chk:cpd:phar
            icon: üëØ
          - name: Mess Detector (CLEAN CODE & DESIGN)
            check: chk:md
            icon: üßπ
          - name: Rector
            check: ci:chk:rector
            icon: ‚ôªÔ∏è
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3' }
      - uses: actions/download-artifact@v4
        with: { name: all-dependencies }
      - run: composer ${{ matrix.check }}

  # =============================================================================
  # [DE] TESTING: UNIT & MUTATION
  # [EN] TESTING: UNIT & MUTATION
  # =============================================================================
  php-testing:
    name: üß™ Unit & Mutation Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: pcov }
      - uses: actions/download-artifact@v4
        with: { name: all-dependencies }
      - run: mkdir -p .build/reports .cache/phpunit
      - name: PHPUnit Tests
        run: composer ci:test:unit:full
      - name: Infection (Mutation)
        run: composer test:mut -- --threads=4 --logger-github --min-msi=30
      - name: Save PHPUnit Report
        if: always()
        uses: actions/upload-artifact@v4
        with: { name: phpunit-html-report, path: .build/reports/phpunit-report.html }

  # =============================================================================
  # [DE] CODE STYLE: FIXER (DRY RUN)
  # [EN] CODE STYLE: FIXER (DRY RUN)
  # =============================================================================
  php-fixer:
    name: üé® PHP-CS-Fixer Check
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3' }
      - uses: actions/download-artifact@v4
        with: { name: all-dependencies }
      - run: composer chk:fixer

  # =============================================================================
  # [DE] SICHERHEIT (SECURITY AUDIT)
  # [EN] SECURITY AUDIT
  # =============================================================================
  security:
    name: üõ°Ô∏è Security Audit (PHP/JS)
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.3' }
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - uses: actions/download-artifact@v4
        with: { name: all-dependencies }
      - name: Composer Audit
        run: composer pkg:audit
      - name: NPM Audit
        run: npm run chk:sec

  # =============================================================================
  # [DE] FRONTEND-QUALIT√ÑT (EIGENE KACHEL PRO CHECK)
  # [EN] FRONTEND QUALITY (SEPARATE CARD PER CHECK)
  # =============================================================================
  frontend-qa:
    name: üåê Frontend ${{ matrix.name }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - {name: "JS (ESLint)", check: "chk:js", icon: "üìú"}
          - {name: "SCSS (Stylelint)", check: "chk:css", icon: "üé®"}
          - {name: "Spelling (CSpell)", check: "chk:sp", icon: "üî§"}
          - {name: "Markdown", check: "chk:md", icon: "üìù"}
          - {name: "Performance (LHCI)", check: "chk:perf", icon: "‚ö°", needs_server: true}
          - {{name: "HTML/A11y (Pa11y)", check: "ci:chk:a11y", icon: "‚ôø", needs_server: true}
    steps:
      - uses: actions/checkout@v4

      # PHP wird nur f√ºr Jobs mit Webserver ben√∂tigt
      - name: Setup PHP (for Server)
        if: matrix.needs_server
        uses: shivammathur/setup-php@v2
        with: { php-version: '8.3', coverage: none }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: { node-version: '20' }

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with: { name: all-dependencies }

      - name: Run Check
        run: |
          if [ "${{ matrix.needs_server }}" == "true" ]; then
            # Server starten f√ºr Lighthouse oder Pa11y
            php -S 127.0.0.1:8000 -t public &
            sleep 3
            npm run ${{ matrix.check }}
          else
            # Normaler statischer Check
            npm run ${{ matrix.check }}
          fi

  # =============================================================================
  # [DE] JS-TESTING: VITEST
  # [EN] JS-TESTING: VITEST
  # =============================================================================
  js-testing:
    name: üß™ JS Unit Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - uses: actions/download-artifact@v4
        with: { name: all-dependencies }
      - name: Run Vitest
        # 'run' sorgt daf√ºr, dass Vitest nicht im Watch-Mode h√§ngen bleibt
        run: npx vitest run

# =============================================================================
  # [DE] PRODUKTIONS-CHECK: BUILD-PROZESS
  # [EN] PRODUCTION-CHECK: BUILD PROCESS
  # =============================================================================
  frontend-build:
    name: üèóÔ∏è Build Assets (Production)
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - uses: actions/download-artifact@v4
        with: { name: all-dependencies }
      - name: Build Production Assets
        run: npm run make
